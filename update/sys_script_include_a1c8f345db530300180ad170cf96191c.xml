<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_183199_testcommv.TestCommvaultEndpoint</api_name>
        <client_callable>true</client_callable>
        <description/>
        <name>TestCommvaultEndpoint</name>
        <script><![CDATA[var TestCommvaultEndpoint = Class.create();
TestCommvaultEndpoint.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
	getHello: function() {
		
		this._getToken();
		
		return "";
	},
	getSchedules: function() {
		var token = this._getToken();
		
		gs.info('Getting schedules using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9001/webconsole/RestServlet/SchedulePolicy");
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
		
	},
	getClients: function() {
		var token = this._getToken();
		
		gs.info('Getting clients using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9001/webconsole/RestServlet/Client?propertylevel=10&Hiddenclients=false&includevm=true");
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setRequestHeader("mode", "EdgeMode");
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
	},
	_getToken: function() {
		gs.info("Getting token");
		
		var username = 'admin';
		var password = 'Builder!12';
		
		var ePassword = gs.base64Encode(password);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9001/webconsole/RestServlet/Login");
		sm.setHttpMethod("post");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Content-Type","application/xml");
		sm.setLogLevel("all");
		
		var body = '<DM2ContentIndexing_CheckCredentialReq mode="Webconsole" username="' + username + '" password="' + ePassword + '" />';
		sm.setRequestBody(body);
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info("Response from get token: " + responseBody);
		
		gs.info('Parsing response');
		
		var responseJson = JSON.parse(responseBody);
		
		gs.info('Response json: ' + responseJson);
		
		gs.info("Token is " + responseJson['token']);
		
		if(responseJson['token']) {
			return responseJson['token'];
		} else {
			return "";
		}
		
	},
    type: 'TestCommvaultEndpoint'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2017-12-26 12:20:08</sys_created_on>
        <sys_id>a1c8f345db530300180ad170cf96191c</sys_id>
        <sys_mod_count>33</sys_mod_count>
        <sys_name>TestCommvaultEndpoint</sys_name>
        <sys_package display_value="TestCommvault" source="x_183199_testcommv">3aafe741db130300180ad170cf961919</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="TestCommvault">3aafe741db130300180ad170cf961919</sys_scope>
        <sys_update_name>sys_script_include_a1c8f345db530300180ad170cf96191c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-02-12 13:24:17</sys_updated_on>
    </sys_script_include>
</record_update>
