<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_183199_testcommv.TestCommvaultEndpoint</api_name>
        <client_callable>true</client_callable>
        <description/>
        <name>TestCommvaultEndpoint</name>
        <script><![CDATA[var TestCommvaultEndpoint = Class.create();
TestCommvaultEndpoint.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
	getHello: function() {
		
		this._getToken();
		
		return "";
	},
	getDataForDataset: function() {
		var token = this._getToken();
		var dataSetId = this.getParameter('sysparm_dataSetId');
		gs.info('Getting Data for Dataset ' + dataSetId + ' using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint('https://winproxy1.commvault.com:9287/CustomReportsEngine/rest/reportsplusengine/datasets/' + dataSetId + '/data');
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
	},
	getSLAReport: function() {
		var token = this._getToken();
		
		gs.info('Getting SLA Reports using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9287/CustomReportsEngine/rest/reportsplusengine/reports/name:Servers%20SLA?includeDrafts=false&version=0");
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
	},
	getSchedules: function() {
		var token = this._getToken();
		
		gs.info('Getting schedules using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9287/webconsole/RestServlet/SchedulePolicy");
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
		
	},
	getClients: function() {
		/*var token = this._getToken();
		
		gs.info('Getting clients using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9287/webconsole/RestServlet/Client?propertylevel=10&Hiddenclients=false&includevm=true");
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setRequestHeader("mode", "EdgeMode");
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();*/
		
		var responseBody = '{ "clientProperties":[ { "clientProps":{ "isVirtualServerDiscoveredClient":false,"clientStatus":0,"isMA":true,"specialClientFlags":0,"isCommCellPackageAbsent":false,"grcMigratedClient":false,"IsDeletedClient":false,"isUserCentricClient":false,"IsVirtualClient":false,"attributes":[ { "name":"Is Unlicensed MA","value":"0" } ] },"client":{ "osInfo":{ "Type":"Windows","SubType":"Server","osId":210,"OsDisplayInfo":{ "ProcessorType":"WinX64","OSName":"Windows Server 2012 R2 Datacenter" } },"idaList":[ { "idaEntity":{ "appName":"Windows File System","_type_":4,"applicationId":33 } },{ "idaEntity":{ "appName":"SQL Server","_type_":4,"applicationId":81 } },{ "idaEntity":{ "appName":"Metrics Reporting Server","_type_":4,"applicationId":121 } } ],"clientEntity":{ "hostName":"skummali-setup.testlab.commvault.com","clientId":2,"clientName":"skummali-setup","displayName":"skummali-setup","clientGUID":"531D992D-B767-461C-9F1E-70492FF4D100" },"versionInfo":{ "UpdateStatus":3,"version":"11 SP11","GalaxyRelease":{ "ReleaseID":16 } } } },{ "clientProps":{ "isVirtualServerDiscoveredClient":false,"clientStatus":268435456,"specialClientFlags":2,"isCommCellPackageAbsent":true,"EnableSnapBackups":false,"grcMigratedClient":false,"isUserCentricClient":false },"client":{ "osInfo":{ "Type":"Windows","SubType":"Server","osId":210,"OsDisplayInfo":{ "ProcessorType":"","OSName":"Windows" } },"idaList":[ { "idaEntity":{ "appName":"Windows File System","_type_":4,"applicationId":33 } } ],"clientEntity":{ "hostName":"EdgeClient20","clientId":4,"clientName":"EdgeClient20","displayName":"EdgeClient20","clientGUID":"D63F3060-2CF4-4FE4-BFDB-F4049217B7F7" },"versionInfo":{ "UpdateStatus":4,"version":"11","GalaxyRelease":{ "ReleaseID":16 } } } },{ "clientProps":{ "isVirtualServerDiscoveredClient":false,"clientStatus":0,"specialClientFlags":0,"isCommCellPackageAbsent":false,"grcMigratedClient":false,"IsDeletedClient":false,"isUserCentricClient":false,"IsVirtualClient":false },"client":{ "osInfo":{ "Type":"Windows","SubType":"Server","osId":210,"OsDisplayInfo":{ "ProcessorType":"WinX64","OSName":"Windows Server 2012 R2 Datacenter" } },"idaList":[ { "idaEntity":{ "appName":"Windows File System","_type_":4,"applicationId":33 } },{ "idaEntity":{ "appName":"SQL Server","_type_":4,"applicationId":81 } } ],"clientEntity":{ "hostName":"sk-vm.testlab.commvault.com","clientId":5,"clientName":"sk-vm","displayName":"sk-vm","clientGUID":"6E5B299C-59F5-4C61-AD2E-F1DB5F072CAE" },"versionInfo":{ "UpdateStatus":3,"version":"11 SP11","GalaxyRelease":{ "ReleaseID":16 } } } },{ "clientProps":{ "isVirtualServerDiscoveredClient":false,"clientStatus":0,"specialClientFlags":0,"isCommCellPackageAbsent":false,"grcMigratedClient":false,"IsDeletedClient":false,"isUserCentricClient":false,"IsVirtualClient":false },"client":{ "osInfo":{ "Type":"Windows","SubType":"Server","osId":210,"OsDisplayInfo":{ "ProcessorType":"WinX64","OSName":"Windows Server 2012 R2 Datacenter" } },"idaList":[ { "idaEntity":{ "appName":"Windows File System","_type_":4,"applicationId":33 } },{ "idaEntity":{ "appName":"MySQL","_type_":4,"applicationId":104 } } ],"clientEntity":{ "hostName":"sk-test.testlab.commvault.com","clientId":6,"clientName":"sk-test","displayName":"sk-test","clientGUID":"D3AEDD35-4DAE-4E9F-A7C1-80D845F8E3AF" },"versionInfo":{ "UpdateStatus":3,"version":"11 SP11","GalaxyRelease":{ "ReleaseID":16 } } } } ] }';
		
		gs.info('Returning response' + responseBody);
		
		
		
		return responseBody;
	},
	getSubclients: function() {
		/*var token = this._getToken();
		var clientId = this.getParameter('sysparm_clientId');
		
		gs.info('Getting clients using token ' + token);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9287/webconsole/RestServlet/client/" + clientId + "/Hierarchy?backedUp=false");
		sm.setHttpMethod("get");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Authtoken", token);
		sm.setLogLevel("all");
		
		var response = sm.execute();
		var responseBody = response.getBody();*/
		
		var responseBody = '{ "entity":[ { "subclientId":2,"applicationId":33,"clientName":"skummali-setup","backupsetId":3,"instanceId":1,"clientId":2,"subclientName":"default","backupsetName":"defaultBackupSet","instanceName":"DefaultInstanceName","appName":"Windows File System" },{ "subclientId":3,"applicationId":33,"clientName":"skummali-setup","backupsetId":4,"instanceId":1,"clientId":2,"subclientName":"IndexingSubclient","backupsetName":"Indexing BackupSet","instanceName":"DefaultInstanceName","appName":"Windows File System" },{ "subclientId":4,"applicationId":121,"clientName":"skummali-setup","backupsetId":5,"instanceId":1,"clientId":2,"subclientName":"default","backupsetName":"defaultBackupSet","instanceName":"DefaultInstanceName","appName":"Metrics Reporting Server" } ] }';
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
	},
	runBackup: function() {
		var token = this._getToken();
		
		var clientId = this.getParameter('sysparm_clientId');
		var clientName = this.getParameter('sysparm_clientName');
		var subclientId = this.getParameter('sysparm_subclientId');
		var subclientName = this.getParameter('sysparm_subclientName');
		var backupsetId = this.getParameter('sysparm_backupsetId');
		var backupsetName = this.getParameter('sysparm_backupsetName');
		var appId = this.getParameter('sysparm_appId');
		var appName = this.getParameter('sysparm_appName');
		var backupLevel = this.getParameter('sysparm_backupLevel');
		
		var entityType = "SUBCLIENT_ENTITY";
		
		var body = '<TMMsg_CreateTaskReq><taskInfo><task taskType="IMMEDIATE"/><associations subclientId="' + subclientId + '" applicationId="' + appId + '" backupsetId="' + backupsetId + '" clientId="' + clientId + '" subclientName="' + subclientName + '" backupsetName="' + backupsetName + '" _type_="' + entityType + '" appName="' + appName + '"/><subTasks><subTask subTaskType="2" operationType="2"/><options><backupOpts backupLevel="' + backupLevel + '"/></options></subTasks></taskInfo></TMMsg_CreateTaskReq>';
		
		gs.info('Sending backup request' + body);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9287/webconsole/RestServlet/CreateTask");
		sm.setHttpMethod("post");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Content-Type","application/xml");
		sm.setRequestHeader("Authtoken", token);
		sm.setLogLevel("all");
		
		sm.setRequestBody(body);
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info('Returning response' + responseBody);
		
		return responseBody;
	},
	_getToken: function() {
		gs.info("Getting token");
		
		var username = 'admin';
		var password = 'Builder!12';
		
		var ePassword = gs.base64Encode(password);
		
		var sm = new sn_ws.RESTMessageV2();
		sm.setEndpoint("https://winproxy1.commvault.com:9287/webconsole/RestServlet/Login");
		sm.setHttpMethod("post");
		sm.setHttpTimeout(80000);
		sm.setRequestHeader("Accept","application/json");
		sm.setRequestHeader("Content-Type","application/xml");
		sm.setLogLevel("all");
		
		var body = '<DM2ContentIndexing_CheckCredentialReq mode="Webconsole" username="' + username + '" password="' + ePassword + '" />';
		sm.setRequestBody(body);
		
		var response = sm.execute();
		var responseBody = response.getBody();
		
		gs.info("Response from get token: " + responseBody);
		
		gs.info('Parsing response');
		
		var responseJson = JSON.parse(responseBody);
		
		gs.info('Response json: ' + responseJson);
		
		gs.info("Token is " + responseJson['token']);
		
		if(responseJson['token']) {
			return responseJson['token'];
		} else {
			return "";
		}
		
	},
    type: 'TestCommvaultEndpoint'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2017-12-26 12:20:08</sys_created_on>
        <sys_id>a1c8f345db530300180ad170cf96191c</sys_id>
        <sys_mod_count>44</sys_mod_count>
        <sys_name>TestCommvaultEndpoint</sys_name>
        <sys_package display_value="TestCommvault" source="x_183199_testcommv">3aafe741db130300180ad170cf961919</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="TestCommvault">3aafe741db130300180ad170cf961919</sys_scope>
        <sys_update_name>sys_script_include_a1c8f345db530300180ad170cf96191c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-03-01 08:21:23</sys_updated_on>
    </sys_script_include>
</record_update>
